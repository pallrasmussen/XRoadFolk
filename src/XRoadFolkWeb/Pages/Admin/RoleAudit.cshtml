@page
@model XRoadFolkWeb.Pages.Admin.RoleAuditModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy="AdminOnly")]
@{
    ViewData["Title"] = "Role Audit";
    IDictionary<string,string?> routeBase = new Dictionary<string,string?>
    {
        {"Max", Model.Max.ToString() },
        {"PageSize", Model.PageSize.ToString() },
        {"FilterUser", Model.FilterUser },
        {"FilterRole", Model.FilterRole },
        {"FilterAction", Model.FilterAction },
        {"FilterSuccess", Model.FilterSuccess?.ToString()?.ToLowerInvariant() }
    };
    var nonce = ViewContext?.HttpContext?.Items?["CSP_NONCE"] as string;
}
@section Styles {
<style nonce="@nonce">
  /* Brighten only audit log table text in dark modes */
  @@media (prefers-color-scheme: dark) { #audit-logs table tbody td { color: rgba(255,255,255,.96); } }
  html.dark-mode #audit-logs table tbody td { color: rgba(255,255,255,.96); }
</style>
}
<div id="audit-logs">
<h1 class="h4 mb-3">Role Audit</h1>
<form method="get" class="row gy-2 gx-3 align-items-end mb-3">
    <div class="col-6 col-md-2">
        <label for="max" class="form-label">Max Snapshot</label>
        <input type="number" class="form-control form-control-sm" id="max" name="Max" value="@Model.Max" min="1" max="5000" />
    </div>
    <div class="col-6 col-md-2">
        <label for="pageSize" class="form-label">Page Size</label>
        <input type="number" class="form-control form-control-sm" id="pageSize" name="PageSize" value="@Model.PageSize" min="1" max="500" />
    </div>
    <div class="col-6 col-md-2">
        <label for="page" class="form-label">Page</label>
        <input type="number" class="form-control form-control-sm" id="page" name="PageNumber" value="@Model.PageNumber" min="1" max="@Model.TotalPages" />
    </div>
    <div class="col-6 col-md-2">
        <label for="fUser" class="form-label">User</label>
        <input type="text" class="form-control form-control-sm" id="fUser" name="FilterUser" value="@Model.FilterUser" />
    </div>
    <div class="col-6 col-md-2">
        <label for="fRole" class="form-label">Role</label>
        <input type="text" class="form-control form-control-sm" id="fRole" name="FilterRole" value="@Model.FilterRole" />
    </div>
    <div class="col-6 col-md-2">
        <label for="fAction" class="form-label">Action</label>
        <input type="text" class="form-control form-control-sm" id="fAction" name="FilterAction" value="@Model.FilterAction" />
    </div>
    <div class="col-6 col-md-2">
        <label for="succ" class="form-label">Success</label>
        <select id="succ" name="FilterSuccess" class="form-select form-select-sm">
            <option value="" selected="@(Model.FilterSuccess is null)">Any</option>
            <option value="true" selected="@(Model.FilterSuccess == true)">Yes</option>
            <option value="false" selected="@(Model.FilterSuccess == false)">No</option>
        </select>
    </div>
    <div class="col-12 col-md-4 d-flex gap-2 mt-2">
        <button class="btn btn-sm btn-primary flex-grow-1" type="submit">Apply</button>
        <a class="btn btn-sm btn-outline-secondary" href="@Url.Page("/Admin/RoleAudit")">Reset</a>
    </div>
    <div class="col-12 d-flex flex-wrap gap-2 mt-1">
        <a class="btn btn-sm btn-outline-success" asp-page-handler="Download" asp-route-format="json" asp-all-route-data="routeBase">Download JSON</a>
        <a class="btn btn-sm btn-outline-success" asp-page-handler="Download" asp-route-format="csv" asp-all-route-data="routeBase">Download CSV</a>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="autoRefreshChk" />
            <label class="form-check-label small" for="autoRefreshChk">Auto-refresh (5s)</label>
        </div>
        <div class="small ms-auto align-self-center text-muted">Total: @Model.Total | Pages: @Model.TotalPages</div>
    </div>
</form>
<div class="table-responsive">
<table class="table table-sm table-striped align-middle mb-0">
    <thead class="table-light">
        <tr>
            <th scope="col">UTC</th>
            <th scope="col">Action</th>
            <th scope="col">Target User</th>
            <th scope="col">Role</th>
            <th scope="col">Actor</th>
            <th scope="col">Success</th>
            <th scope="col">Details</th>
        </tr>
    </thead>
    <tbody>
    @if (Model.Entries.Count == 0)
    {
        <tr><td colspan="7" class="text-muted small">No audit entries.</td></tr>
    }
    else
    {
        foreach (var e in Model.Entries)
        {
            <tr class="@(e.Success ? null : "table-danger")">
                <td class="text-nowrap small">@e.UtcTimestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                <td class="small">@e.Action</td>
                <td class="small">@e.User</td>
                <td class="small">@e.Role</td>
                <td class="small">@e.Actor</td>
                <td class="small">@(e.Success?"Yes":"No")</td>
                <td class="small">@e.Details</td>
            </tr>
        }
    }
    </tbody>
</table>
</div>
@{
    int prev = Model.PageNumber - 1;
    int next = Model.PageNumber + 1;
    IDictionary<string,string?> BaseRouteWith(int page) => new Dictionary<string,string?>(routeBase) { ["PageNumber"] = page.ToString() };
}
<nav class="mt-3" aria-label="Audit pagination">
    <ul class="pagination pagination-sm mb-0 flex-wrap">
        <li class="page-item @(Model.PageNumber == 1 ? "disabled" : null)">
            <a class="page-link" asp-page="/Admin/RoleAudit" asp-all-route-data="@BaseRouteWith(1)">First</a>
        </li>
        <li class="page-item @(Model.PageNumber == 1 ? "disabled" : null)">
            <a class="page-link" asp-page="/Admin/RoleAudit" asp-all-route-data="@BaseRouteWith(prev)">Prev</a>
        </li>
        <li class="page-item active"><span class="page-link">@Model.PageNumber</span></li>
        <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : null)">
            <a class="page-link" asp-page="/Admin/RoleAudit" asp-all-route-data="@BaseRouteWith(next)">Next</a>
        </li>
        <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : null)">
            <a class="page-link" asp-page="/Admin/RoleAudit" asp-all-route-data="@BaseRouteWith(Model.TotalPages)">Last</a>
        </li>
    </ul>
</nav>
</div>
@section Scripts {
<script nonce="@(ViewContext?.HttpContext?.Items?["CSP_NONCE"] as string)">
(function(){
  const chk=document.getElementById('autoRefreshChk'); if(!chk) return; let timer=null; function tick(){ if(!chk.checked) return; const url=new URL(window.location.href); url.searchParams.set('_r',Date.now().toString()); fetch(url,{headers:{'X-Requested-With':'fetch'}}).then(r=>r.text()).then(html=>{ try{ const parser=new DOMParser(); const doc=parser.parseFromString(html,'text/html'); const tbody=doc.querySelector('tbody'); const curTbody=document.querySelector('tbody'); if(tbody&&curTbody){ curTbody.replaceWith(tbody); } }catch{} if(chk.checked){ timer=setTimeout(tick,5000);} }); }
  chk.addEventListener('change',()=>{ if(chk.checked){ tick(); } else if(timer){ clearTimeout(timer);} });
})();
</script>
}

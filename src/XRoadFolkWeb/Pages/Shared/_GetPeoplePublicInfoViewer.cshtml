@using System.Text.Json
@using XRoadFolkWeb.Extensions
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer L
@{
    var raw = (string?)(ViewData["RawXml"]) ?? "";
    var pretty = (string?)(ViewData["PrettyXml"]) ?? "";

    var gpivI18n = new {
        NoXmlToDisplay = L["NoXmlToDisplay"].Value,
        NoXmlRoot = L["NoXmlRoot"].Value,
        FailedToRenderTreePrefix = L["FailedToRenderTreePrefix"].Value,
        NoPeopleFound = L["NoPeopleFound"].Value,
        PeopleLabel = L["PeopleLabel"].Value,
        Basics = L["Basics"].Value,
        Names = L["Names"].Value,
        Name = L["Name"].Value,
        PublicId = L["PublicId"].Value,
        DOB = L["DOB"].Value,
        Status = L["Status"].Value,
        Expand = L["Expand"].Value,
        Collapse = L["Collapse"].Value,
        ExtendedSearch = L["ExtendedSearch"].Value,
        Fullscreen = L["Fullscreen"].Value,
        ToggleFullscreen = L["ToggleFullscreen"].Value
    };
    var nonce = Context?.Items?["CSP_NONCE"] as string;
}
<style nonce="@nonce">
    .gpiv-card { position: relative; }
    .gpiv-toolbar { position: sticky; top: -1px; z-index: 2; background: var(--bs-body-bg); padding-top: .25rem; }
    .gpiv-card.gpiv-fullscreen { position: fixed; inset: 0; z-index: 1050; margin: 0; border-radius: 0; background: var(--bs-body-bg); height: auto !important; }
    .gpiv-card .card-body { display: flex; flex-direction: column; min-height: 0; }
    .gpiv-card .gpiv-viewport { flex: 1 1 auto; min-height: 0; overflow: auto; }
    .gpiv-card.gpiv-fullscreen .card-body { height: 100dvh; }
    .gpiv-card.gpiv-fullscreen .gpiv-viewport { max-height: none; }
    .gpiv-drop { display: none; position: absolute; inset: 0; z-index: 3; background: rgba(0,0,0,.05); border: 2px dashed var(--bs-secondary); align-items: center; justify-content: center; text-align: center; padding: 2rem; border-radius: .375rem; }
    .gpiv-drop .msg { font-size: .95rem; color: var(--bs-secondary); }
    @@keyframes gpivFlash { 0% { background: rgba(255, 243, 205, .9); } 100% { background: transparent; } }
    .gpiv-highlight { animation: gpivFlash 1.5s ease-out 1; }

    /* SUMMARY: match person-details accordion exactly */
    #gpiv-xml-summary .accordion-button { padding: .5rem .75rem; font-weight: 600; }
    #gpiv-xml-summary .accordion-item + .accordion-item { border-top: 1px solid var(--bs-border-color); }
    #gpiv-xml-summary .accordion-body { padding: 0; }

    /* Table readability tweaks to match person-details */
    #gpiv-xml-summary .table { margin: 0; }
    #gpiv-xml-summary .table th {
        width: 35%;
        background: var(--bs-tertiary-bg, var(--bs-secondary-bg-subtle));
        color: var(--bs-secondary-color);
    }
    #gpiv-xml-summary .table th,
    #gpiv-xml-summary .table td {
        vertical-align: top;
        word-break: break-word;
    }
    #gpiv-xml-summary .table tbody tr:hover th,
    #gpiv-xml-summary .table tbody tr:hover td {
        background: var(--bs-secondary-bg-subtle);
    }

    /* Person header inside the scrolling summary viewport (non-sticky) */
    #gpiv-xml-summary .gpiv-person { position: static; }
    #gpiv-xml-summary .gpiv-person-header {
        position: static;
        background: transparent;
        border-bottom: none;
        padding-block: .25rem;
    }
</style>

<div class="card shadow-sm mb-4 gpiv-card">
    <div class="gpiv-drop" id="gpiv-drop">
        <div class="msg"><div class="mb-1">@L["DropXmlHint"]</div></div>
    </div>

    <div class="card-body">
        <!-- Toolbar: no buttons now (Fullscreen moved next to Expand/Collapse) -->
        <div class="gpiv-toolbar d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2 border-bottom pb-2">
          <h5 class="card-title mb-0">@L["GetPeoplePublicInfo"]</h5>
          <div class="d-flex flex-wrap gap-2 align-items-center"><!-- empty --></div>
        </div>

        <div id="gpiv-empty" class="text-muted small mb-2" style="display:none;">@L["EmptyState"]</div>
        <div id="gpiv-xml-summary" class="gpiv-viewport mb-0 small p-3 border rounded"></div>
    </div>
</div>

<script nonce="@nonce" type="application/json" id="gpiv-i18n-json">@Html.Raw(JsonSerializer.Serialize(gpivI18n))</script>
<script nonce="@nonce" type="application/json" id="gpiv-raw-json">@Html.Raw(JsonSerializer.Serialize(raw))</script>
<script nonce="@nonce" type="application/json" id="gpiv-pretty-json">@Html.Raw(JsonSerializer.Serialize(pretty))</script>

<!-- Externalized viewer script (cacheable). Uses console.error for surfaced errors. -->
<script src="~/js/gpiv-viewer.js" asp-append-version="true" defer></script>
<!-- Externalized person details loader to avoid inline scripts -->
<script src="~/js/gpiv-person-details-loader.js" asp-append-version="true" defer></script>
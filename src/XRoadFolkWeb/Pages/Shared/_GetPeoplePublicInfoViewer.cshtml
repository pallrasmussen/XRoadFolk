@using System.Text.Json
@using XRoadFolkWeb.Extensions
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer L
@{
    var raw = (string?)(ViewData["RawXml"]) ?? "";
    var pretty = (string?)(ViewData["PrettyXml"]) ?? "";

    var gpivI18n = new {
        NoXmlToDisplay = L["NoXmlToDisplay"].Value,
        NoXmlRoot = L["NoXmlRoot"].Value,
        FailedToRenderTreePrefix = L["FailedToRenderTreePrefix"].Value,
        NoPeopleFound = L["NoPeopleFound"].Value,
        PeopleLabel = L["PeopleLabel"].Value,
        Basics = L["Basics"].Value,
        Names = L["Names"].Value,
        Name = L["Name"].Value,
        PublicId = L["PublicId"].Value,
        DOB = L["DOB"].Value,
        Status = L["Status"].Value,
        Expand = L["Expand"].Value,
        Collapse = L["Collapse"].Value,
        ExtendedSearch = L["ExtendedSearch"].Value,
        Fullscreen = L["Fullscreen"].Value,
        ToggleFullscreen = L["ToggleFullscreen"].Value
    };
    var nonce = Context?.Items?["CSP_NONCE"] as string;
}
<style nonce="@nonce">
    .gpiv-card { position: relative; }
    .gpiv-toolbar { position: sticky; top: -1px; z-index: 2; background: var(--bs-body-bg); padding-top: .25rem; }
    .gpiv-card.gpiv-fullscreen { position: fixed; inset: 0; z-index: 1050; margin: 0; border-radius: 0; background: var(--bs-body-bg); height: auto !important; }
    .gpiv-card .card-body { display: flex; flex-direction: column; min-height: 0; }
    .gpiv-card .gpiv-viewport { flex: 1 1 auto; min-height: 0; overflow: auto; }
    .gpiv-card.gpiv-fullscreen .card-body { height: 100dvh; }
    .gpiv-card.gpiv-fullscreen .gpiv-viewport { max-height: none; }
    .gpiv-drop { display: none; position: absolute; inset: 0; z-index: 3; background: rgba(0,0,0,.05); border: 2px dashed var(--bs-secondary); align-items: center; justify-content: center; text-align: center; padding: 2rem; border-radius: .375rem; }
    .gpiv-drop .msg { font-size: .95rem; color: var(--bs-secondary); }
    @@keyframes gpivFlash { 0% { background: rgba(255, 243, 205, .9); } 100% { background: transparent; } }
    .gpiv-highlight { animation: gpivFlash 1.5s ease-out 1; }

    /* SUMMARY: match person-details accordion exactly */
    #gpiv-xml-summary .accordion-button { padding: .5rem .75rem; font-weight: 600; }
    #gpiv-xml-summary .accordion-item + .accordion-item { border-top: 1px solid var(--bs-border-color); }
    #gpiv-xml-summary .accordion-body { padding: 0; }

    /* Table readability tweaks to match person-details */
    #gpiv-xml-summary .table { margin: 0; }
    #gpiv-xml-summary .table th {
        width: 35%;
        background: var(--bs-tertiary-bg, var(--bs-secondary-bg-subtle));
        color: var(--bs-secondary-color);
    }
    #gpiv-xml-summary .table th,
    #gpiv-xml-summary .table td {
        vertical-align: top;
        word-break: break-word;
    }
    #gpiv-xml-summary .table tbody tr:hover th,
    #gpiv-xml-summary .table tbody tr:hover td {
        background: var(--bs-secondary-bg-subtle);
    }

    /* Person header inside the scrolling summary viewport (non-sticky) */
    #gpiv-xml-summary .gpiv-person { position: static; }
    #gpiv-xml-summary .gpiv-person-header {
        position: static;
        background: transparent;
        border-bottom: none;
        padding-block: .25rem;
    }
</style>

<div class="card shadow-sm mb-4 gpiv-card">
    <div class="gpiv-drop" id="gpiv-drop">
        <div class="msg"><div class="mb-1">@L["DropXmlHint"]</div></div>
    </div>

    <div class="card-body">
        <!-- Toolbar: no buttons now (Fullscreen moved next to Expand/Collapse) -->
        <div class="gpiv-toolbar d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2 border-bottom pb-2">
          <h5 class="card-title mb-0">@L["GetPeoplePublicInfo"]</h5>
          <div class="d-flex flex-wrap gap-2 align-items-center"><!-- empty --></div>
        </div>

        <div id="gpiv-empty" class="text-muted small mb-2" style="display:none;">@L["EmptyState"]</div>
        <div id="gpiv-xml-summary" class="gpiv-viewport mb-0 small p-3 border rounded"></div>
    </div>
</div>

<script type="application/json" id="gpiv-i18n-json">@Html.Raw(JsonSerializer.Serialize(gpivI18n))</script>
<script type="application/json" id="gpiv-raw-json">@Html.Raw(JsonSerializer.Serialize(raw))</script>
<script type="application/json" id="gpiv-pretty-json">@Html.Raw(JsonSerializer.Serialize(pretty))</script>

<script nonce="@nonce">
(function () {
    // Fullscreen is handled via delegated handler; button is created in summary header next to Expand/Collapse.

    var I18N = {};
    try {
        var i18nEl = document.getElementById('gpiv-i18n-json');
        if (i18nEl) I18N = JSON.parse(i18nEl.textContent || '{}');
    } catch (e) { try{ console.debug('GPIV: parse i18n failed', e); }catch{} }

    var dropOverlay = document.getElementById('gpiv-drop');

    var summaryHost = document.getElementById('gpiv-xml-summary');
    var emptyMsg = document.getElementById('gpiv-empty');
    var card = document.querySelector('.gpiv-card');

    var sourcePretty = '';
    var sourceRaw = '';

    function parseXml(text) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(text, 'application/xml');
        var err = doc.querySelector('parsererror');
        if (err) throw new Error(err.textContent || 'Invalid XML');
        return doc;
    }
    function el(tag, cls, text) {
        var e = document.createElement(tag);
        if (cls) e.className = cls;
        if (text != null) e.textContent = text;
        return e;
    }

    // Height sync with People Search card
    function syncViewerHeight() {
        try {
            var search = document.getElementById('people-search-card');
            if (!search || !card) return;
            if (card.classList.contains('gpiv-fullscreen')) {
                card.style.height = '';
                return;
            }
            var h = Math.round(search.getBoundingClientRect().height);
            if (h > 0) card.style.height = h + 'px';
        } catch (e) { try{ console.debug('GPIV: syncViewerHeight failed', e); }catch{} }
    }

    // Observe left card and window resizes
    try {
        var ro = new ResizeObserver(function(){ syncViewerHeight(); });
        var sc = document.getElementById('people-search-card');
        if (sc) ro.observe(sc);
    } catch (e) { try{ console.debug('GPIV: ResizeObserver failed', e); }catch{} }
    window.addEventListener('resize', syncViewerHeight);

    // Icon mapping for group titles (viewer)
    function iconClassFor(title) {
      var t = String(title || '').toLowerCase();
      if (t === 'summary') return 'bi-list-check';
      if (t === 'person' || t === 'names' || t === 'name') return 'bi-person-lines-fill';
      if (t === 'biologicalparents' || t === 'parents' || t.includes('parent') || t.includes('guardian') || t.includes('family')) return 'bi-people-fill';
      if (t.includes('basic') || t.includes('personal') || t === 'basics' || t.includes('overview') || t.includes('core')) return 'bi-person-vcard';
      if (t.includes('address' ) || t.includes('resid') || t.includes('domic') || t.includes('location') || t.includes('geo') || t.includes('place')) return 'bi-geo-alt';
      if (t.includes('status') || t.includes('civilstatus') || t.includes('marital')) return 'bi-patch-check';
      if (t.includes('employment') || t.includes('job') || t.includes('work') || t.includes('occupation') || t.includes('employer')) return 'bi-briefcase';
      if (t.includes('education') || t.includes('school') || t.includes('study') || t.includes('degree')) return 'bi-mortarboard';
      if (t.includes('document') || t.includes('certificate') || t.includes('doc') || t.includes('file') || t.includes('paper')) return 'bi-file-earmark-text';
      if (t.includes('bank') || t.includes('account') || t.includes('finance') || t.includes('iban') || t.includes('bic') || t.includes('payment')) return 'bi-wallet2';
      if (t.includes('email') || t.includes('mail')) return 'bi-envelope-at';
      if (t.includes('contact') || t.includes('phone') || t.includes('mobile') || t.includes('tel') || t.includes('fax')) return 'bi-telephone';
      if (t.includes('id') || t.includes('ident') || t.includes('passport') || t.includes('card') || t.includes('vcard')) return 'bi-person-vcard';
      if (t.includes('date') || t.includes('period') || t.includes('valid')) return 'bi-calendar-event';
      if (t.includes('nation') || t.includes('citizen') || t.includes('nationality') || t.includes('country')) return 'bi-flag';
      return 'bi-list-ul';
    }
    function buildHeaderBtnContent(btn, titleText) {
      btn.textContent = '';
      var ic = document.createElement('i'); ic.className = 'bi ' + iconClassFor(titleText) + ' me-2'; ic.setAttribute('aria-hidden','true');
      btn.appendChild(ic);
      btn.appendChild(document.createTextNode(titleText || ''));
    }

    // Summary helpers
    function isNil(node) {
      if (!node || node.nodeType !== 1 || !node.attributes) return false;
      for (var i = 0; i < node.attributes.length; i++) {
        var a = node.attributes[i];
        var ln = a.localName || a.name;
        if (ln === 'nil' && /^(true|1)$/i.test((a.value || '').trim())) return true;
      }
      return false;
    }
    function hasElementChildren(node) {
      if (!node || !node.children) return false;
      for (var i = 0; i < node.children.length; i++) if (!isNil(node.children[i])) return true;
      return false;
    }
    function isNoiseKey(name) {
      if (!name) return false;
      var n = String(name).toLowerCase();
      return n === 'id' || n === 'fixed' || n === 'authoritycode' || n === 'personaddressid';
    }
    var atSign = String.fromCharCode(64);
    function buildKvpTableIncludingAttributes(owner) {
      var rows = [];
      if (owner && owner.attributes && owner.attributes.length) {
        for (var i = 0; i < owner.attributes.length; i++) {
          var a = owner.attributes[i];
          var attrName = a.localName || a.name || '';
          if (isNoiseKey(attrName)) continue; // filter noise attributes
          rows.push({ key: atSign + (a.name || ''), val: (a.value || '') });
        }
      }
      var kids = owner && owner.children ? owner.children : [];
      for (var k = 0; k < kids.length; k++) {
        var ch = kids[k];
        if (isNil(ch)) continue;
        if (!hasElementChildren(ch)) {
          if (isNoiseKey(ch.localName)) continue; // filter noise elements
          rows.push({ key: ch.localName, val: (ch.textContent || '').trim() });
          if (ch.attributes && ch.attributes.length) {
            for (var a2 = 0; a2 < ch.attributes.length; a2++) {
              var at = ch.attributes[a2];
              var atName = at.localName || at.name || '';
              if (isNoiseKey(atName)) continue; // filter noise child attributes
              rows.push({ key: ch.localName + ' ' + atSign + (at.name || ''), val: (at.value || '') });
            }
          }
        }
      }
      if (!rows.length) return null;
      var wrap = document.createElement('div'); wrap.className = 'table-responsive';
      var t = document.createElement('table'); t.className = 'table table-sm table-striped align-middle mb-0';
      var tb = document.createElement('tbody');
      for (var r = 0; r < rows.length; r++) {
        var tr = document.createElement('tr');
        var th = document.createElement('th'); th.className = 'text-muted fw-normal'; th.style.width = '36%'; th.textContent = rows[r].key;
        var td = document.createElement('td'); td.textContent = rows[r].val;
        tr.appendChild(th); tr.appendChild(td); tb.appendChild(tr);
      }
      t.appendChild(tb); wrap.appendChild(t);
      return wrap;
    }
    function getTextLocal(elx, name) {
      if (!elx || !elx.children) return '';
      for (var i = 0; i < elx.children.length; i++) {
        var c = elx.children[i];
        if (c.localName === name) return (c.textContent || '').trim();
      }
      return '';
    }
    function badge(text) {
      var b = document.createElement('span');
      b.className = 'badge text-bg-light';
      b.textContent = text;
      return b;
    }

    // Build a single accordion item helper
    function accItem(accId, idx, title, bodyContent, open) {
        var item = document.createElement('div'); item.className = 'accordion-item';
        var hid = accId + '-h-' + idx; var cid = accId + '-c-' + idx;
        var h2 = document.createElement('h2'); h2.className = 'accordion-header'; h2.id = hid;
        var btn = document.createElement('button'); btn.type = 'button'; btn.className = 'accordion-button' + (open ? '' : ' collapsed');
        btn.setAttribute('data-bs-toggle', 'collapse'); btn.setAttribute('data-bs-target', '#' + cid);
        btn.setAttribute('aria-expanded', open ? 'true' : 'false'); btn.setAttribute('aria-controls', cid);
        buildHeaderBtnContent(btn, title || '');
        h2.appendChild(btn);
        var col = document.createElement('div'); col.id = cid; col.className = 'accordion-collapse collapse' + (open ? ' show' : '');
        col.setAttribute('aria-labelledby', hid);
        var body = document.createElement('div'); body.className = 'accordion-body p-0';
        if (bodyContent) body.appendChild(bodyContent);
        col.appendChild(body);
        item.appendChild(h2); item.appendChild(col);
        return item;
    }

    // Summary using Bootstrap accordion
    function renderSummary() {
        summaryHost.innerHTML = '';
        try {
            var xmlText = (sourceRaw && sourceRaw.trim()) ? sourceRaw : (sourcePretty || '');
            if (!xmlText.trim()) { summaryHost.textContent = I18N.NoXmlToDisplay || 'No XML to display.'; syncViewerHeight(); return; }
            var xml = parseXml(xmlText);
            var people = []; var all = xml.getElementsByTagName('*');
            for (var i = 0; i < all.length; i++) if (all[i].localName === 'PersonPublicInfo') people.push(all[i]);
            if (people.length === 0) { summaryHost.appendChild(el('div', 'text-muted', I18N.NoPeopleFound || 'No PersonPublicInfo elements found.')); syncViewerHeight(); return; }

            var hdr = el('div', 'mb-2 d-flex align-items-center gap-2', null);
            var cnt = el('strong', null, (I18N.PeopleLabel || 'People') + ': ' + people.length); cnt.id = 'gpiv-people-count';
            hdr.appendChild(cnt);

            // Expand/Collapse + Fullscreen buttons next to the count (match Person Details look)
            var grp = el('div', 'd-flex flex-wrap gap-2 ms-auto', null);
            var bExpand = el('button', 'btn btn-sm btn-outline-secondary', null); bExpand.id = 'gpiv-summary-expand';
            bExpand.appendChild(el('i', 'bi bi-chevron-double-down me-1', ''));
            bExpand.appendChild(document.createTextNode(I18N.Expand || 'Expand'));
            var bFs = el('button', 'btn btn-sm btn-outline-secondary', null); bFs.id = 'gpiv-fullscreen'; bFs.title = I18N.ToggleFullscreen || 'Toggle fullscreen';
            bFs.appendChild(el('i', 'bi bi-arrows-fullscreen me-1', ''));
            bFs.appendChild(document.createTextNode(I18N.Fullscreen || 'Fullscreen'));
            var bCollapse = el('button', 'btn btn-sm btn-outline-secondary', null); bCollapse.id = 'gpiv-summary-collapse';
            bCollapse.appendChild(el('i', 'bi bi-chevron-double-up me-1', ''));
            bCollapse.appendChild(document.createTextNode(I18N.Collapse || 'Collapse'));
            grp.appendChild(bExpand); grp.appendChild(bCollapse); grp.appendChild(bFs);
            hdr.appendChild(grp);
            summaryHost.appendChild(hdr);

            bExpand.addEventListener('click', function(){ expandSummaryAll(true); });
            bCollapse.addEventListener('click', function(){ expandSummaryAll(false); });

            for (var p = 0; p < people.length; p++) {
                var person = people[p];
                var wrap = document.createElement('div'); wrap.className = 'mb-3 p-2 border rounded gpiv-person';
                wrap.setAttribute('data-idx', String(p));

                // Header row (non-sticky)
                var header = el('div', 'gpiv-person-header d-flex flex-wrap gap-2 align-items-baseline mb-2', null);
                header.appendChild(el('span', 'badge text-bg-secondary', '#' + (p + 1)));

                // Build name display
                var nameRoot = null;
                for (var nc = 0; nc < person.children.length; nc++) { if (person.children[nc].localName === 'Names') { nameRoot = person.children[nc]; break; } }
                var fullName = '';
                if (nameRoot) {
                    var firsts = []; var last = '';
                    for (var nn = 0; nn < nameRoot.children.length; nn++) {
                        var nm = nameRoot.children[nn]; if (nm.localName !== 'Name' || isNil(nm)) continue;
                        var tp = getTextLocal(nm, 'Type'); if (tp === 'FirstName') {
                            var order = parseInt(getTextLocal(nm, 'Order') || '9999', 10);
                            firsts.push({ o: isNaN(order) ? 9999 : order, v: getTextLocal(nm, 'Value') });
                        } else if (tp === 'LastName') last = getTextLocal(nm, 'Value') || last;
                    }
                    firsts.sort(function (a, b) { return a.o - b.o; });
                    var joined = []; for (var fj = 0; fj < firsts.length; fj++) joined.push(firsts[fj].v);
                    fullName = (joined.join(' ') + ' ' + last).trim();
                }
                var nameEl = document.createElement('strong'); nameEl.textContent = fullName || '-'; header.appendChild(nameEl);

                var publicId = getTextLocal(person, 'PublicId') || getTextLocal(person, 'PersonId');
                var dob = (getTextLocal(person, 'DateOfBirth') || '').slice(0, 10);

                wrap.dataset.name = fullName || '';
                wrap.dataset.publicId = publicId || '';
                wrap.dataset.dob = dob || '';

                if (dob) header.appendChild(badge((I18N.DOB || 'DOB') + ': ' + dob));

                if (publicId) {
                    var pidBtn = document.createElement('button');
                    pidBtn.type = 'button';
                    pidBtn.className = 'btn btn-sm btn-outline-secondary gpiv-pid ms-auto';
                    pidBtn.setAttribute('data-public-id', publicId);
                    pidBtn.textContent = (I18N.ExtendedSearch || 'Extended search');
                    header.appendChild(pidBtn);
                }

                wrap.appendChild(header);

                // Accordion for this person
                var accId = 'gpiv-acc-' + p + '-' + Date.now();
                var acc = document.createElement('div'); acc.className = 'accordion'; acc.id = accId;

                // Names section
                if (nameRoot) {
                    var list = document.createElement('div'); list.className = 'd-flex flex-column gap-2';
                    var nameItems = [];
                    for (var n2 = 0; n2 < nameRoot.children.length; n2++) {
                        var nItem = nameRoot.children[n2];
                        if (nItem.localName !== 'Name' || isNil(nItem)) continue;
                        var ord = parseInt(getTextLocal(nItem, 'Order') || '9999', 10); if (isNaN(ord)) ord = 9999;
                        nameItems.push({ node: nItem, order: ord });
                    }
                    nameItems.sort(function(a,b){ return a.order - b.order; });
                    for (var ix = 0; ix < nameItems.length; ix++) {
                        var nNode = nameItems[ix].node;
                        var card2 = el('div', 'p-2 border rounded', null);
                        var title2 = el('div', 'small text-muted mb-1', (I18N.Name || 'Name') + ' #' + (ix + 1));
                        card2.appendChild(title2);
                        var t2 = buildKvpTableIncludingAttributes(nNode); if (t2) card2.appendChild(t2);
                        list.appendChild(card2);
                    }
                    acc.appendChild(accItem(accId, acc.childElementCount, I18N.Names || 'Names', list, false));
                }

                // Basics section
                var basicsTable = buildKvpTableIncludingAttributes(person);
                if (basicsTable) acc.appendChild(accItem(accId, acc.childElementCount, I18N.Basics || 'Basics', basicsTable, false));

                // Other groups
                var groups = [];
                for (var g = 0; g < person.children.length; g++) {
                    var ch = person.children[g]; if (isNil(ch)) continue; if (ch.localName === 'Names' || ch.localName === 'CivilStatus') continue; if (hasElementChildren(ch)) groups.push(ch);
                }
                for (var gi = 0; gi < groups.length; gi++) {
                    var group = groups[gi];
                    var counts = {}; for (var kk = 0; kk < group.children.length; kk++) { var lk = group.children[kk]; if (isNil(lk)) continue; var nm2 = lk.localName; counts[nm2] = (counts[nm2] || 0) + 1; }
                    var repeated = null; for (var key in counts) { if (counts[key] > 1) { repeated = key; break; } }

                    if (repeated) {
                        var items = []; for (var itx = 0; itx < group.children.length; itx++) { var it = group.children[itx]; if (!isNil(it) && it.localName === repeated) items.push(it); }
                        var listWrap = document.createElement('div'); listWrap.className = 'd-flex flex-column gap-2';
                        for (var itx2 = 0; itx2 < items.length; itx2++) {
                            var card3 = el('div', 'p-2 border rounded', null);
                            var title3 = el('div', 'small text-muted mb-1', repeated + ' #' + (itx2 + 1));
                            card3.appendChild(title3);
                            var leaves2 = buildKvpTableIncludingAttributes(items[itx2]); if (leaves2) card3.appendChild(leaves2);
                            // build nested details as simple blocks
                            var nested = []; for (var nc = 0; nc < items[itx2].children.length; nc++) { var kid = items[itx2].children[nc]; if (!isNil(kid) && hasElementChildren(kid)) nested.push(kid); }
                            for (var nx = 0; nx < nested.length; nx++) {
                                var sub = buildKvpTableIncludingAttributes(nested[nx]); if (sub) card3.appendChild(sub);
                            }
                            listWrap.appendChild(card3);
                        }
                        acc.appendChild(accItem(accId, acc.childElementCount, group.localName, listWrap, false));
                    } else {
                        var leaves = buildKvpTableIncludingAttributes(group);
                        acc.appendChild(accItem(accId, acc.childElementCount, group.localName, leaves, false));
                    }
                }

                wrap.appendChild(acc);
                summaryHost.appendChild(wrap);
            }

            // After rendering, sync height once
            syncViewerHeight();
        } catch (e) {
            summaryHost.textContent = (I18N.FailedToBuildSummaryPrefix || 'Failed to build summary:') + ' ' + (e && e.message ? e.message : e);
            syncViewerHeight();
        }
    }

    // Expand/Collapse helpers (summary)
    function expandSummaryAll(open) {
        if (!summaryHost) return;
        var panes = summaryHost.querySelectorAll('.accordion-collapse');
        panes.forEach(function(p){ p.classList.toggle('show', !!open); });
        var btns = summaryHost.querySelectorAll('.accordion-button');
        btns.forEach(function(b){ b.classList.toggle('collapsed', !open); });
    }

    function updateView() {
        var combined = (sourceRaw && sourceRaw.trim()) || (sourcePretty && sourcePretty.trim()) || '';
        var hasAny = combined.length > 0;

        if (emptyMsg) emptyMsg.style.display = hasAny ? 'none' : 'block';
        if (hasAny) { renderSummary(); } else { summaryHost.innerHTML = ''; syncViewerHeight(); }
    }

    // Load: Drag & Drop only
    function setXmlFromText(text) {
        if (!text || !text.trim()) return;
        sourceRaw = text; sourcePretty = text;
        updateView();
    }
    function showDrop(v) { if (dropOverlay) dropOverlay.style.display = v ? 'flex' : 'none'; }
    card && card.addEventListener('dragenter', function (e) { e.preventDefault(); showDrop(true); });
    card && card.addEventListener('dragover', function (e) { e.preventDefault(); showDrop(true); });
    card && card.addEventListener('dragleave', function (e) { e.preventDefault(); showDrop(false); });
    card && card.addEventListener('drop', function (e) {
        e.preventDefault(); showDrop(false);
        var dt = e.dataTransfer; if (!dt) return;
        if (dt.files && dt.files.length) {
            var f = dt.files[0]; var reader = new FileReader();
            reader.onload = function () { setXmlFromText(String(reader.result || '')); };
            reader.readAsText(f);
        } else {
            var txt = dt.getData('text') || '';
            setXmlFromText(txt);
        }
    });

    // Delegated handlers: Fullscreen toggle (viewer only)
    document.addEventListener('click', function(e){
        var t = e.target;
        if (t && (t.id === 'gpiv-fullscreen' || (t.closest && t.closest('#gpiv-fullscreen')))) {
            if (card) {
                var entering = !card.classList.contains('gpiv-fullscreen');
                card.classList.toggle('gpiv-fullscreen');
                if (entering) { card.style.height = ''; }
                else { syncViewerHeight(); }
            }
        }
        // NOTE: Person Details fullscreen is handled centrally in Index.cshtml
    });

    // Keyboard shortcuts (unchanged)
    document.addEventListener('keydown', function (e) {
        var t = e.target;
        var tag = t && t.tagName ? t.tagName.toLowerCase() : '';
        var inEditable = t && (t.isContentEditable || tag === 'input' || t === 'textarea' || tag === 'select');
        if (inEditable) return;

        if (e.key.toLowerCase() === 'e') { expandSummaryAll(true); }
        if (e.key.toLowerCase() === 'c' && !(e.ctrlKey || e.metaKey)) { expandSummaryAll(false); }
    });

    window.gpiv = {
        setXml: function (raw, pretty) {
            if (typeof raw === 'string') sourceRaw = raw;
            if (typeof pretty === 'string') sourcePretty = pretty; else if (typeof raw === 'string' ) sourcePretty = raw;
            updateView();
        },
        focusPerson: function (publicId) {
            if (!publicId) return;
            updateView();
            var badges = summaryHost.querySelectorAll('.gpiv-pid');
            for (var i = 0; i < badges.length; i++) {
                var pidAttr = badges[i].getAttribute('data-public-id') || '';
                if (pidAttr === publicId || (badges[i].textContent || '').indexOf(publicId) >= 0) {
                    var wrap = badges[i];
                    while (wrap && wrap !== summaryHost && !wrap.classList.contains('border')) wrap = wrap.parentElement;
                    if (wrap && wrap.scrollIntoView) { wrap.scrollIntoView({ block: 'center' }); wrap.classList.add('gpiv-highlight'); setTimeout(function () { wrap.classList.remove('gpiv-highlight'); }, 1500); }
                    break;
                }
            }
        }
    };

    try {
        var rawEl = document.getElementById('gpiv-raw-json');
        var prettyEl = document.getElementById('gpiv-pretty-json');
        var rawInit = rawEl ? JSON.parse(rawEl.textContent || '""') : "";
        var prettyInit = prettyEl ? JSON.parse(prettyEl.textContent || '""') : "";
        if (rawInit || prettyInit) window.gpiv.setXml(rawInit, prettyInit);
    } catch (e) { try{ console.debug('GPIV: initial setXml failed', e); }catch{} }

    try {
        var qs = new URLSearchParams(window.location.search);
        var linkPid = qs.get('gpivPublicId');
        if (linkPid) { setTimeout(function () { window.gpiv.focusPerson(linkPid); }, 50); }
    } catch (e) { try{ console.debug('GPIV: focusPerson from query failed', e); }catch{} }

    // Initial height sync
    syncViewerHeight();
})();
</script>
<script nonce="@nonce">
(function () {
    try {
        var rawEl = document.getElementById('gpiv-raw-json');
        var prettyEl = document.getElementById('gpiv-pretty-json');
        var raw = rawEl ? JSON.parse(rawEl.textContent || '""') : "";
        var pretty = prettyEl ? JSON.parse(prettyEl.textContent || '""') : "";
        if (window.gpiv && (raw || pretty)) window.gpiv.setXml(raw, pretty);
    } catch (e) { try{ console.debug('GPIV: secondary setXml failed', e); }catch{} }
})();
</script>
<!-- Remaining scripts preserved below (Person Details loader) -->
<script nonce="@nonce">
// Restore PublicId click -> load PersonDetails panel behavior (logs removed)
(function(){
  if (window.__gpivPidHooked) return;
  window.__gpivPidHooked = true;

  var personCache = (window.personCache instanceof Map) ? window.personCache : (window.personCache = new Map());
  var lastPid = window.lastPid || null;

  function getPanelEls() {
    return {
      sec: document.getElementById('person-details-section'),
      body: document.getElementById('person-details-body'),
      err: document.getElementById('person-details-error'),
      loading: document.getElementById('person-details-loading'),
      title: document.querySelector('#person-details-section .card-title')
    };
  }
  function showLoading(on){
    var e=getPanelEls(); if(!e.sec) return;
    e.sec.classList.remove('d-none');
    if(e.err){ e.err.classList.add('d-none'); e.err.textContent=''; }
    if(e.loading){ e.loading.classList.toggle('d-none', !on); }
  }
  function clearPanel(){
    var e=getPanelEls(); if(!e.sec) return;
    e.sec.classList.remove('d-none');
    if(e.err){ e.err.classList.add('d-none'); e.err.textContent=''; }
    if(e.body){ e.body.innerHTML=''; }
    if(e.loading){ e.loading.classList.add('d-none'); }
  }
  function ensureShownAndFocus(){
    var e=getPanelEls(); if(!e.sec) return;
    e.sec.classList.remove('d-none');
    if(e.title){
      e.title.setAttribute('tabindex','-1');
      try{ e.title.focus({preventScroll:true}); }catch(ex){ try{ console.debug('GPIV: focus failed', ex); }catch{} }
      try{ e.title.scrollIntoView({block:'start', behavior:'smooth'});}catch(ex2){ try{ console.debug('GPIV: scrollIntoView failed', ex2); }catch{} }
    }
  }
  function markSelectedSummaryCard(fromEl){
    try {
      var host = document.getElementById('gpiv-xml-summary'); if (!host) return;
      var prev = host.querySelector('.gpiv-active-card'); if (prev) prev.classList.remove('gpiv-active-card');
      var wrap = fromEl;
      while (wrap && wrap !== host && !(wrap.classList && wrap.classList.contains('border') && wrap.classList.contains('rounded'))) wrap = wrap.parentElement;
      if (wrap && wrap !== host) wrap.classList.add('gpiv-active-card');
    } catch (e) { try{ console.debug('GPIV: markSelectedSummaryCard failed', e); }catch{} }
  }

  function defaultRenderPairsGrouped(pairs){
    function iconClassForPd(name){
      var t = String(name || '').toLowerCase();
      if (t === 'summary') return 'bi-list-check';
      if (t === 'person' || t === 'names' || t === 'name') return 'bi-person-lines-fill';
      if (t === 'biologicalparents' || t === 'parents' || t.includes('parent') || t.includes('guardian') || t.includes('family')) return 'bi-people-fill';
      if (t.includes('basic') || t.includes('personal') || t === 'basics' || t.includes('overview') || t.includes('core')) return 'bi-person-vcard';
      if (t.includes('address') || t.includes('resid') || t.includes('domic') || t.includes('location') || t.includes('geo') || t.includes('place')) return 'bi-geo-alt';
      if (t.includes('status') || t.includes('civilstatus') || t.includes('marital')) return 'bi-patch-check';
      if (t.includes('employment') || t.includes('job') || t.includes('work') || t.includes('occupation') || t.includes('employer')) return 'bi-briefcase';
      if (t.includes('education') || t.includes('school') || t.includes('study') || t.includes('degree')) return 'bi-mortarboard';
      if (t.includes('document') || t.includes('certificate') || t.includes('doc') || t.includes('file') || t.includes('paper')) return 'bi-file-earmark-text';
      if (t.includes('bank') || t.includes('account') || t.includes('finance') || t.includes('iban') || t.includes('bic') || t.includes('payment')) return 'bi-wallet2';
      if (t.includes('email') || t.includes('mail')) return 'bi-envelope-at';
      if (t.includes('contact') || t.includes('phone') || t.includes('mobile') || t.includes('tel') || t.includes('fax')) return 'bi-telephone';
      if (t.includes('id') || t.includes('ident') || t.includes('passport') || t.includes('card') || t.includes('vcard')) return 'bi-person-vcard';
      if (t.includes('date') || t.includes('period') || t.includes('valid')) return 'bi-calendar-event';
      if (t.includes('nation') || t.includes('citizen') || t.includes('nationality') || t.includes('country')) return 'bi-flag';
      return 'bi-list-ul';
    }

    var groups = {};
    (pairs||[]).forEach(function(p){
      var k=p.key||'', v=p.value||'';
      var seg=k.includes('.') ? k.slice(0,k.indexOf('.')) : k;
      (groups[seg]=groups[seg]||[]).push({k:k,v:v});
    });
    var keys = Object.keys(groups).sort(function(a,b){
      var ai=a.toLowerCase()==='summary'?0:1, bi=b.toLowerCase()==='summary'?0:1;
      return (ai-bi)||a.localeCompare(b);
    });
    var accId='pd-acc-'+Date.now();
    var acc=document.createElement('div'); acc.className='accordion'; acc.id=accId;

    keys.forEach(function(name, gi){
      var items=groups[name].slice().sort(function(x,y){ return x.k.localeCompare(y.k); });
      var hid=accId+'-h-'+gi, cid=accId+'-c-'+gi;

      var item=document.createElement('div'); item.className='accordion-item'; item.setAttribute('data-group', name);

      var h2=document.createElement('h2'); h2.className='accordion-header'; h2.id=hid;
      var btn=document.createElement('button'); btn.className='accordion-button'+(name.toLowerCase()==='summary'?'':' collapsed');
      btn.type='button'; btn.setAttribute('data-bs-toggle','collapse'); btn.setAttribute('data-bs-target','#'+cid);
      btn.setAttribute('aria-expanded', name.toLowerCase()==='summary'?'true':'false'); btn.setAttribute('aria-controls', cid);
      // Build header content with icon
      var ic = document.createElement('i'); ic.className='bi '+iconClassForPd(name)+' me-2'; ic.setAttribute('aria-hidden','true');
      btn.appendChild(ic); btn.appendChild(document.createTextNode(name));
      h2.appendChild(btn);

      var col=document.createElement('div'); col.id=cid; col.className='accordion-collapse collapse'+(name.toLowerCase()==='summary'?' show':'');
      col.setAttribute('aria-labelledby', hid); col.setAttribute('data-bs-parent','#'+accId);

      var body=document.createElement('div'); body.className='accordion-body p-0';
      var respWrap=document.createElement('div'); respWrap.className='table-responsive';
      var table=document.createElement('table'); table.className='table table-sm table-striped align-middle mb-0';
      var tb=document.createElement('tbody');

      items.forEach(function(it){
        var k=it.k, v=it.v;
        var lastDot=k.lastIndexOf('.'); var sub=lastDot>=0?k.slice(lastDot+1):k;
        var bpos=sub.indexOf('['); if(bpos>=0) sub=sub.slice(0,bpos);
        var tr=document.createElement('tr');
        var th=document.createElement('th'); th.className='text-muted fw-normal'; th.style.width='36%'; th.textContent=sub;
        var td=document.createElement('td'); td.textContent=v;
        tr.appendChild(th); tr.appendChild(td); tb.appendChild(tr);
      });

      table.appendChild(tb); respWrap.appendChild(table); body.appendChild(respWrap); col.appendChild(body); item.appendChild(h2); item.appendChild(col); acc.appendChild(item);
    });
    return acc;
  }

  async function fetchDetails(publicId){
    var url = new URL(window.location.href);
    url.searchParams.set('handler','PersonDetails');
    url.searchParams.set('publicId', publicId);
    var resp = await fetch(url.toString(), { headers: { 'Accept':'application/json' } });
    var ct = (resp.headers.get('content-type') || '').toLowerCase();
    var data = null;
    if (ct.includes('application/json')) data = await resp.json();
    else { var text = await resp.text(); data = { ok: false, error: text && text.length < 500 ? text : 'Non-JSON response (' + resp.status + ')' }; }
    if (!resp.ok) data.ok = false;
    return data;
  }

  async function loadPerson(publicId, sourceEl){
    window.lastPid = lastPid = publicId;
    var els = getPanelEls();
    if(!publicId || !els.body) return;

    var cached = personCache.get(publicId);
    if (cached && cached.details && cached.details.length) {
      clearPanel();
      var builder = (window._renderPairsGroupedForPerson || defaultRenderPairsGrouped);
      var accCached = builder(cached.details);
      if (accCached) els.body.appendChild(accCached);
      ensureShownAndFocus();
    } else {
      clearPanel(); showLoading(true);
    }

    try {
      var data = await fetchDetails(publicId);
      showLoading(false);

      if (!data || data.ok !== true) {
        if (els.err) {
          var msg = (data && data.error) ? String(data.error) : 'Failed to load details.';
          els.err.innerHTML = 'Failed to load details. <button type="button" id="pd-retry" class="btn btn-sm btn-outline-secondary ms-2">Retry</button>';
          els.err.classList.remove('d-none');
          var retry = document.getElementById('pd-retry');
          retry && retry.addEventListener('click', function(){ loadPerson(publicId, sourceEl); });
          ensureShownAndFocus();
        }
        return;
      }

      if (!data.details || !data.details.length) {
        clearPanel();
        return;
      }

      personCache.set(publicId, { details: data.details || [], ts: Date.now() });

      clearPanel();
      var builder2 = (window._renderPairsGroupedForPerson || defaultRenderPairsGrouped);
      var acc = builder2(data.details || []);
      if (acc) els.body.appendChild(acc);
      ensureShownAndFocus();

      if (sourceEl) markSelectedSummaryCard(sourceEl);

      try{
        var link = new URL(window.location.href);
        link.searchParams.set('gpivPublicId', publicId);
        history.pushState(null,'',link.toString());
      }catch(ex){ try{ console.debug('GPIV: history.pushState failed', ex); }catch{} }
    } catch (err) {
      showLoading(false);
      if (els.err) {
        els.err.innerHTML = 'Failed to load details. <button type="button" id="pd-retry" class="btn btn-sm btn-outline-secondary ms-2">Retry</button>';
        els.err.classList.remove('d-none');
        var retry2 = document.getElementById('pd-retry');
        retry2 && retry2.addEventListener('click', function(){ loadPerson(publicId, sourceEl); });
        ensureShownAndFocus();
      }
      try { console.error('GetPerson fetch failed', err); } catch {}
    }
  }

  document.addEventListener('click', function(e){
    var btn = e.target && e.target.closest && e.target.closest('.gpiv-pid');
    if(!btn) return;
    if(e.ctrlKey || e.metaKey) return;
    e.preventDefault();
    // If viewer is fullscreen, exit it first so details panel is visible
    try {
      var viewer = document.querySelector('.gpiv-card');
      if (viewer && viewer.classList.contains('gpiv-fullscreen')) viewer.classList.remove('gpiv-fullscreen');
    } catch {}
    var pid = btn.getAttribute('data-public-id') || '';
    if(!pid){
      var txt = btn.textContent || '';
      var parts = txt.split(':');
      pid = parts.length>1 ? parts.slice(1).join(':').trim() : '';
    }
    if(pid) loadPerson(pid, btn);
  });

  try{
    var qs=new URLSearchParams(window.location.search);
    var pid=qs.get('gpivPublicId');
    if(pid){
      if(document.readyState==='loading') {
        window.addEventListener('DOMContentLoaded', function(){ loadPerson(pid); });
      } else {
        loadPerson(pid);
      }
    }
  }catch(e){ try{ console.debug('GPIV: initial gpivPublicId load failed', e); }catch{} }

  // Expand/Collapse all panels inside Person Details (accordion)
  function pdToggleAll(open){
    try{
      var host = document.getElementById('person-details-section');
      if (!host) return;
      var panes = host.querySelectorAll('.accordion-collapse');
      panes.forEach(function(p){ p.classList.toggle('show', !!open); });
      var btns = host.querySelectorAll('.accordion-button');
      btns.forEach(function(b){ b.classList.toggle('collapsed', !open); });
    }catch(e){ try{ console.debug('GPIV: pdToggleAll failed', e); }catch{} }
  }
  document.addEventListener('click', function(e){
    var t = e.target && e.target.id || '';
    if (t === 'pd-expand-all') pdToggleAll(true);
    if (t === 'pd-collapse-all') pdToggleAll(false);
  });
})();
</script>
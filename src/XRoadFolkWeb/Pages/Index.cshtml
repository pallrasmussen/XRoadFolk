@page
@model XRoadFolkWeb.Pages.IndexModel
@using System.Reflection
@using XRoadFolkWeb.Pages
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer IViewLocalizer
@{
    var L = IViewLocalizer; // alias to keep existing L[...] calls intact
    ViewData["Title"] = L["Title"];
    var nonce = ViewContext?.HttpContext?.Items?["CSP_NONCE"] as string;

    // Expose version to layout footer (Index page only)
    var appAsm = typeof(Program).Assembly;
    var infoVersion = appAsm.GetCustomAttribute<AssemblyInformationalVersionAttribute>()?.InformationalVersion
                      ?? appAsm.GetName().Version?.ToString();
    ViewData["AppVersion"] = infoVersion;

    // Date bounds for HTML5 date picker (progressive enhancement) - not used in custom mask
    string todayIso = DateTime.UtcNow.ToString("yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
}

<h1 class="mb-4">@L["Title"]</h1>

<div class="row g-4 align-items-start">
    <!-- People Search (kept as-is) -->
    <div class="col-12 col-lg-5 col-xxl-4" id="people-search-card">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">@L["SearchCriteria"]</h5>
                <p class="text-muted mb-3">@L["ProvideCriteria"]</p>

                <form method="post" asp-antiforgery="true" class="row gy-3" id="gpip-search-form" autocomplete="off">
                    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>

                    <div class="col-12">
                        <label asp-for="Ssn" class="form-label"></label>
                        <input asp-for="Ssn" class="form-control"
                               autocomplete="off" autocapitalize="off" spellcheck="false"
                               data-val-ssnornamedob="@XRoadFolkWeb.Resources.ValidationMessages.ProvideSsnOrNameDob"
                               data-val-ssnornamedob-ssn="Ssn"
                               data-val-ssnornamedob-first="FirstName"
                               data-val-ssnornamedob-last="LastName"
                               data-val-ssnornamedob-dob="DateOfBirth" />
                        <span asp-validation-for="Ssn" class="text-danger small"></span>
                    </div>

                    <div class="col-12">
                        <div class="text-center text-muted-sep">@L["OrSeparator"]</div>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="FirstName" class="form-label"></label>
                        <input asp-for="FirstName" class="form-control" autocomplete="off" autocapitalize="off" spellcheck="false" />
                        <span asp-validation-for="FirstName" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="LastName" class="form-label"></label>
                        <input asp-for="LastName" class="form-control" autocomplete="off" autocapitalize="off" spellcheck="false" />
                        <span asp-validation-for="LastName" class="text-danger small"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="DateOfBirth" class="form-label"></label>
                        <input asp-for="DateOfBirth" type="text" class="form-control" placeholder="@L["DateFormatPlaceholder"]"
                               autocomplete="off" autocapitalize="off" spellcheck="false" />
                        <span asp-validation-for="DateOfBirth" class="text-danger small"></span>
                    </div>

                    <div class="col-12 d-grid d-sm-flex gap-2 mt-2">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-search me-1" aria-hidden="true"></i>@L["Search"]</button>
                        <button type="submit" asp-page-handler="@PageHandlers.Clear" class="btn btn-outline-secondary">@L["Clear"]</button>
                    </div>
                </form>

                @if (Model.Errors?.Count > 0)
                {
                    <div class="alert alert-danger mt-3" role="alert">
                        <strong>@L["InputErrors"]</strong>
                        <ul class="mb-0">
                            @foreach (var e in Model.Errors)
                            {
                                <li>@e</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- GetPeoplePublicInfo viewer & Person Details combined -->
    <div class="col-12 col-lg-7 col-xxl-8 min-w-0">
        @if (Model?.HasSearched == true && Model?.Results?.Count > 0)
        {
            <partial name="_GetPeoplePublicInfoViewer"
                     view-data='new ViewDataDictionary(ViewData) {
                         ["RawXml"] = Model?.PeoplePublicInfoResponseXml ?? string.Empty,
                         ["PrettyXml"] = Model?.PeoplePublicInfoResponseXmlPretty ?? string.Empty,
                         ["InitialPublicId"] = Model?.Results?.FirstOrDefault()?.PublicId ?? string.Empty
                     }' />
        }

        @if (Model?.HasSearched == true && Model?.Results?.Count == 0)
        {
            <div class="alert alert-info mt-3" role="status">@L["NoPeopleFound"]</div>
        }
    </div>
</div>

@section Styles {
    <link href="~/css/person-details.css" rel="stylesheet" asp-append-version="true" />
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/validation-ssn.js"></script>
    <script src="~/js/validation-name.js"></script>
    <script src="~/js/validation-dob.js"></script>
    <script src="~/js/validation-ssn-or-name-dob.js"></script>
    <script src="~/js/validation-letters-only.js"></script>
    <script src="~/js/index-clear-details.js" asp-append-version="true" defer></script>
    <script src="~/js/index-form-state.js" asp-append-version="true" defer></script>
    <script src="~/js/date-mask.js" asp-append-version="true" defer></script>
}

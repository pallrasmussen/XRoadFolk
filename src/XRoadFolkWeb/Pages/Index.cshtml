@page
@model XRoadFolkWeb.Pages.IndexModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer L
@{
    ViewData["Title"] = L["Title"];
    var nonce = HttpContext?.Items?["CSP_NONCE"] as string;
}

<h1 class="mb-4">@L["Title"]</h1>

<style nonce="@nonce">
  /* Person Details fullscreen styles */
  #person-details-section.pd-fullscreen {
    position: fixed;
    inset: 0;
    z-index: 1050;
    margin: 0;
    border-radius: 0;
    background: var(--bs-body-bg);
  }
  #person-details-section.pd-fullscreen .card-body {
    height: 100dvh;
    display: flex;
    flex-direction: column;
  }
  #person-details-section.pd-fullscreen #person-details-body {
    flex: 1 1 auto;
    min-height: 0;
    overflow: auto;
  }
</style>

<div class="row g-4 align-items-start">
    <!-- People Search (kept as-is) -->
    <div class="col-12 col-lg-5 col-xxl-4">
        <div id="people-search-card" class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">@L["SearchCriteria"]</h5>
                <p class="text-muted mb-3">@L["ProvideCriteria"]</p>

                <form method="post" class="row gy-3" id="gpip-search-form">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>

                    <div class="col-12">
                        <label asp-for="Ssn" class="form-label"></label>
                        <input asp-for="Ssn" class="form-control"
                               data-val-ssnornamedob="@XRoadFolkWeb.Resources.ValidationMessages.ProvideSsnOrNameDob"
                               data-val-ssnornamedob-ssn="Ssn"
                               data-val-ssnornamedob-first="FirstName"
                               data-val-ssnornamedob-last="LastName"
                               data-val-ssnornamedob-dob="DateOfBirth" />
                        <span asp-validation-for="Ssn" class="text-danger small"></span>
                    </div>

                    <div class="col-12">
                        <div class="text-center text-muted-sep">@L["OrSeparator"]</div>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="FirstName" class="form-label"></label>
                        <input asp-for="FirstName" class="form-control" />
                        <span asp-validation-for="FirstName" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="LastName" class="form-label"></label>
                        <input asp-for="LastName" class="form-control" />
                        <span asp-validation-for="LastName" class="text-danger small"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="DateOfBirth" class="form-label"></label>
                        <input asp-for="DateOfBirth" class="form-control" placeholder="@L["DateFormatPlaceholder"]" />
                        <span asp-validation-for="DateOfBirth" class="text-danger small"></span>
                    </div>

                    <div class="col-12 d-grid d-sm-flex gap-2 mt-2">
                        <button type="submit" class="btn btn-primary">@L["Search"]</button>
                        <button type="submit" asp-page-handler="Clear" class="btn btn-outline-secondary">@L["Clear"]</button>
                    </div>
                </form>

                @if (Model.Errors?.Count > 0)
                {
                    <div class="alert alert-danger mt-3" role="alert">
                        <strong>@L["InputErrors"]</strong>
                        <ul class="mb-0">
                            @foreach (var e in Model.Errors)
                            {
                                <li>@e</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- GetPeoplePublicInfo viewer -->
    <div class="col-12 col-lg-7 col-xxl-8 min-w-0">
        @if ((Model?.Results?.Count ?? 0) > 0)
        {
            <partial name="_GetPeoplePublicInfoViewer"
                     view-data='new ViewDataDictionary(ViewData) {
                         ["RawXml"] = Model?.PeoplePublicInfoResponseXml ?? string.Empty,
                         ["PrettyXml"] = Model?.PeoplePublicInfoResponseXmlPretty ?? string.Empty
                     }' />
        }
        else if (Model?.PeoplePublicInfoResponseXml != null)
        {
            <div class="alert alert-info" role="status">@L["NoPeopleFound"]</div>
        }

        <!-- GetPerson response (AJAX-filled; kept separate and below the viewer) -->
        <div id="person-details-section" class="card shadow-sm mb-4 person-details d-none" role="region" aria-labelledby="pd-title">
          <div class="card-body">
            <div class="pd-toolbar d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2 border-bottom pb-2">
              <h5 id="pd-title" class="card-title mb-0">
                @L["PersonDetails"]
                @if (!string.IsNullOrWhiteSpace(Model?.SelectedNameSuffix))
                {
                    <small class="text-muted ms-2">@Model.SelectedNameSuffix</small>
                }
              </h5>

              <div class="d-flex flex-wrap gap-2">
                <button type="button" id="pd-expand-all" class="btn btn-sm btn-outline-secondary">@L["Expand"]</button>
                <button type="button" id="pd-collapse-all" class="btn btn-sm btn-outline-secondary">@L["Collapse"]</button>
                <button type="button" id="pd-fullscreen" class="btn btn-sm btn-outline-secondary" title="@L["ToggleFullscreen"]">
                  <i class="bi bi-arrows-fullscreen me-1" aria-hidden="true"></i>@L["Fullscreen"]
                </button>
              </div>
            </div>

            <div id="person-details-loading" class="text-muted small d-none" aria-live="polite">@L["Loading"]?</div>
            <div id="person-details-error" class="alert alert-danger d-none" role="alert" aria-live="assertive"></div>

            <div id="person-details-body"><!-- accordion injected here --></div>
          </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/validation-ssn.js" asp-append-version="true"></script>
    <script src="~/js/validation-name.js" asp-append-version="true"></script>
    <script src="~/js/validation-dob.js" asp-append-version="true"></script>
    <script src="~/js/validation-ssn-or-name-dob.js" asp-append-version="true"></script>
}
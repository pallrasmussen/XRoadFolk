(function(){"use strict";let d=(u,L)=>{try{L&&console&&console.debug&&console.debug(u,L)}catch{}};function X(){try{let u=document.getElementById("logs-i18n-json");return u?JSON.parse(u.textContent||"{}"):{}}catch(u){return d("logs:i18n",u),{}}}let F=!1;function U(){if(F)return;F=!0;let u=X(),L=document.getElementById("logs-view"),m=L&&L.getAttribute("data-default-kind")||"http",y="table",B=!1,O="",D="",C=null,_=500,p=document.querySelector("#logs-table tbody"),f=document.querySelector(".logs-table-container"),g=document.getElementById("logs-cards"),S=document.getElementById("logs-filter"),H=document.getElementById("logs-level"),$=document.getElementById("logs-clear"),b=document.getElementById("logs-pause"),V=document.getElementById("logs-download"),M=document.getElementById("logs-status"),I=document.getElementById("logs-count"),Y=b&&b.getAttribute("data-i18n-pause")||"Pause",G=b&&b.getAttribute("data-i18n-resume")||"Resume",a=(t,e,n)=>{let o=document.createElement(t);return e&&(o.className=e),n!=null&&(o.textContent=String(n)),o},q=t=>a("span","badge lvl-badge badge-"+String(t||""),String(t||"")),h=(t,e=2)=>(t=String(t),t.length>=e?t:"0".repeat(e-t.length)+t),J=t=>{try{let e=new Date(t);if(isNaN(e))return t;let n=e.getFullYear(),o=h(e.getMonth()+1),l=h(e.getDate()),r=h(e.getHours()),s=h(e.getMinutes()),i=h(e.getSeconds()),c=h(e.getMilliseconds(),3),T=-e.getTimezoneOffset(),rt=T>=0?"+":"-",W=Math.abs(T),at=h(Math.floor(W/60)),ct=h(W%60);return`${n}-${o}-${l} ${r}:${s}:${i}.${c} ${rt}${at}:${ct}`}catch{return t}};function Q(t){let e=document.createElement("tr"),n=a("td",null,J(t.timestamp));e.appendChild(n);let o=a("td");o.appendChild(q(t.level)),e.appendChild(o);let l=a("td",null,t.category||"");e.appendChild(l);let r=a("td",null,t.message||"");e.appendChild(r);let s=a("td","text-end"),i=a("button","btn btn-sm btn-outline-dark",u.Copy||"Copy");return i.setAttribute("data-action","copy"),i.setAttribute("aria-label","Copy"),s.appendChild(i),e.appendChild(s),e.__entry=t,e}function Z(t){let e=a("div","col");e.setAttribute("role","article");let n=a("div","card log-card");n.setAttribute("data-level",String(t.level||""));let o=a("div","card-body"),l=a("div","d-flex justify-content-between align-items-start"),r=a("div");if(r.appendChild(a("div","small text-muted",t.category||"")),r.appendChild(a("div","fw-semibold",J(t.timestamp))),l.appendChild(r),l.appendChild(q(t.level)),o.appendChild(l),o.appendChild(a("div","log-message mt-2",t.message||"")),t.exception){let c=a("details","mt-2");c.appendChild(a("summary",null,"Exception"));let T=a("pre","mb-0");T.textContent=t.exception,c.appendChild(T),o.appendChild(c)}let s=a("div","d-flex justify-content-end mt-2"),i=a("button","btn btn-sm btn-outline-dark",u.Copy||"Copy");return i.setAttribute("data-action","copy"),i.setAttribute("aria-label","Copy"),s.appendChild(i),o.appendChild(s),n.appendChild(o),e.appendChild(n),e.__entry=t,e}function P(){y==="cards"?(g.classList.remove("d-none"),g.setAttribute("aria-hidden","false"),f.classList.add("d-none"),f.setAttribute("aria-hidden","true")):(f.classList.remove("d-none"),f.setAttribute("aria-hidden","false"),g.classList.add("d-none"),g.setAttribute("aria-hidden","true")),N()}let R=3e3,z=2e3,tt=50,v=[],A=[],w=0,x=[],dt=()=>{if(w){try{clearTimeout(w)}catch(t){d("logs:cancelFlush",t)}w=0}};function et(){w||(w=setTimeout(N,tt))}function N(){if(w=0,!v.length&&!A.length)return;let t=!1;try{y==="table"&&f&&(t=f.scrollTop+f.clientHeight>=f.scrollHeight-8)}catch(e){d("logs:autoscroll",e)}if(v.length){let e=document.createDocumentFragment();for(let n=0;n<v.length;n++)e.appendChild(v[n]);v=[],p.appendChild(e),nt()}if(A.length){let e=document.createDocumentFragment();for(let n=0;n<A.length;n++)e.appendChild(A[n]);A=[],g.appendChild(e),ot()}if(t&&f)try{f.scrollTop=f.scrollHeight}catch(e){d("logs:scroll",e)}y==="cards"?x=Array.prototype.map.call(g.children,e=>e.__entry).filter(Boolean):x=Array.prototype.map.call(p.children,e=>e.__entry).filter(Boolean),I&&(I.textContent=String(x.length||0)),M&&(M.textContent=(x.length||0)+" "+(u.Entries||"entries"))}function nt(){try{let t=p.children.length-R;if(t>0){let e=Math.max(t,p.children.length-z);for(let n=0;n<e&&p.firstChild;n++)p.removeChild(p.firstChild)}}catch(t){d("logs:trimRows",t)}}function ot(){try{let t=g.children.length-R;if(t>0){let e=Math.max(t,g.children.length-z);for(let n=0;n<e&&g.firstChild;n++)g.removeChild(g.firstChild)}}catch(t){d("logs:trimCards",t)}}let it=t=>!(D&&String(t.level).toLowerCase()!==D||O&&((t.message||"")+" "+(t.category||"")).toLowerCase().indexOf(O)<0);function K(t){if(!it(t))return;let e=Q(t);v.push(e);let n=Z(t);A.push(n),et()}function j(){if(C)try{C.close()}catch(t){d("logs:es-close",t)}C=new EventSource("/logs/stream?kind="+encodeURIComponent(m)),C.onmessage=function(t){if(_=500,!B)try{let e=JSON.parse(t.data);K(e)}catch(e){console.warn("LogsViewer: JSON parse failed",e)}},C.onerror=function(){try{C.close()}catch(e){d("logs:es-close-err",e)}let t=_*(1+Math.random()*.25);_=Math.min(_*2,15e3),setTimeout(j,t)}}function E(){p.innerHTML="",g.innerHTML="",x=[],I&&(I.textContent="0"),M&&(M.textContent=""),fetch("/logs?kind="+encodeURIComponent(m)).then(t=>t.json()).then(t=>{if(!t||t.ok!==!0)return;let e=t.items||[];e.length>R&&(e=e.slice(e.length-R));for(let n=0;n<e.length;n++)K(e[n]);N()}).catch(t=>d("logs:reloadHistory",t))}function lt(t){let e=document.querySelector(t);if(!e)return;let n=Array.prototype.slice.call(e.querySelectorAll("[data-kind], [data-view]"));n.forEach((o,l)=>{o.setAttribute("tabindex",l===0?"0":"-1"),o.setAttribute("role","button")}),e.addEventListener("keydown",o=>{let l=o.target&&o.target.closest&&o.target.closest("[data-kind], [data-view]");if(!l)return;let r=n.indexOf(l);if(r<0)return;let s=o.key;if(s==="ArrowRight"||s==="ArrowDown"){o.preventDefault();let i=(r+1)%n.length;n.forEach(c=>c.setAttribute("tabindex","-1")),n[i].setAttribute("tabindex","0"),n[i].focus()}else if(s==="ArrowLeft"||s==="ArrowUp"){o.preventDefault();let i=(r-1+n.length)%n.length;n.forEach(c=>c.setAttribute("tabindex","-1")),n[i].setAttribute("tabindex","0"),n[i].focus()}else s==="Home"?(o.preventDefault(),n.forEach(i=>i.setAttribute("tabindex","-1")),n[0].setAttribute("tabindex","0"),n[0].focus()):s==="End"&&(o.preventDefault(),n.forEach(i=>i.setAttribute("tabindex","-1")),n[n.length-1].setAttribute("tabindex","0"),n[n.length-1].focus())})}let k=0,st=200;S&&S.addEventListener("input",()=>{if(O=String(S.value||"").toLowerCase(),k)try{clearTimeout(k)}catch(t){d("logs:clearDebounce",t)}k=setTimeout(()=>{E()},st)}),H&&H.addEventListener("change",()=>{D=String(H.value||"").toLowerCase(),E()}),S&&S.addEventListener("keydown",t=>{if(t.key==="Enter"){if(k)try{clearTimeout(k)}catch(e){d("logs:enterClearDebounce",e)}E()}}),$&&$.addEventListener("click",()=>{fetch("/logs/clear",{method:"POST"}).then(()=>E())}),b&&b.addEventListener("click",()=>{B=!B,b.textContent=B?G:Y}),V&&V.addEventListener("click",()=>{try{let t=new Blob([JSON.stringify(x||[],null,2)],{type:"application/json"}),e=document.createElement("a");e.href=URL.createObjectURL(t),e.download="logs_"+(m||"all")+"_"+new Date().toISOString().replace(/[:.]/g,"-")+".json",document.body.appendChild(e),e.click(),setTimeout(()=>{try{URL.revokeObjectURL(e.href)}catch(n){d("logs:revokeUrl",n)}try{document.body.removeChild(e)}catch(n){d("logs:removeLink",n)}},0)}catch(t){console.warn("LogsViewer: download failed",t)}}),document.addEventListener("click",t=>{let e=t.target&&t.target.closest?t.target.closest("[data-kind]"):null;if(e&&e.hasAttribute("data-kind")){let l=e.getAttribute("data-kind")||"";if(l&&l!==m){m=l;let r=document.querySelectorAll("[data-kind]");for(let s=0;s<r.length;s++){let i=r[s],c=i.getAttribute("data-kind")===m;i.classList.toggle("active",c),i.setAttribute("aria-pressed",c?"true":"false")}E(),j()}return}let n=t.target&&t.target.closest?t.target.closest("[data-view]"):null;if(n&&n.hasAttribute("data-view")){let l=n.getAttribute("data-view")||"table";if(l!==y){y=l;let r=document.querySelectorAll("[data-view]");for(let s=0;s<r.length;s++){let i=r[s],c=i.getAttribute("data-view")===y;i.classList.toggle("active",c),i.setAttribute("aria-pressed",c?"true":"false")}P()}return}let o=t.target&&t.target.closest?t.target.closest('[data-action="copy"]'):null;if(o)try{let l=o.closest("tr")||o.closest(".col"),r=l&&l.__entry?l.__entry:null,s=r?r.message||JSON.stringify(r):"";navigator.clipboard&&navigator.clipboard.writeText&&navigator.clipboard.writeText(s),o.textContent=u.Copied||"Copied",setTimeout(()=>{o.textContent=u.Copy||"Copy"},1200)}catch(l){d("logs:copy",l)}}),P(),E(),j(),lt('#logs-section .btn-group[role="group"]')}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",U):U()})();
